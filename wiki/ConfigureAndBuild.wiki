#summary Configure and build instructions.

<wiki:toc max_depth="4" />
== Prepare your host environment ==
=== Hardware ===
To work with CanyonLands you will need the following:
 * Board
 * Host machine (Linux Ubuntu 8.x/9.04) with Ethernet card and serial port
 * Serial cable (null-modem)
 * ATX Power supply
 * USB Hub
 * USB Ethernet adapter
 * USB Keyboard & Mouse
 * USB stick
 * Ethernet cross cable or Ethernet Switch/Hub+2 cables
 * Serial ATA HDD or IDE HDD with PCI/PCIe IDE controller
 * PCIe Video adapter (Currently supported are XGI Volari z9s/z9m/z11)
 * VGA cable
 
=== Software ===
As Google we recommend to use Ubuntu 8.04+ , but also you can use CentOS 5.x/RHEL 5.x
 * Install tftp server
 * Install [http://source.android.com/download/using-repo repo] tool 
 * Set up your Linux development environment, make sure you have the following:
Required packages:

{{{
Git 1.5.4 or newer and the GNU Privacy Guard. 
JDK 5.0, update 12 or higher.  Java 6 is not supported, because of incompatibilities with @Override.
flex, bison, gperf, libsdl-dev, libesd0-dev, libwxgtk2.6-dev (optional), build-essential, zip, curl, minicom, tftp-server, uboot-mkimage
}}}
For Ubuntu 32-bit use such command:
{{{
$ sudo apt-get install git-core gnupg sun-java5-jdk flex bison gperf libsdl-dev libesd0-dev libwxgtk2.6-dev build-essential zip curl libncurses5-dev zlib1g-dev minicom tftpd uboot-mkimage
}}}

== Configure your network ==
 * Configure your host Ethernet adapter
{{{
sudo ifconfig ethX 10.10.10.1 netmask 255.255.255.0 up
}}}
 * Configure TFTP-server
/etc/xinet.d/tftpd:
{{{
service tftp
{
protocol        = udp
port            = 69
socket_type     = dgram
wait            = yes
user            = nobody
server          = /usr/sbin/in.tftpd
server_args     = /tftpboot
disable         = no
}
}}}
 * Configure NFS server
 TBD

== Checkout sources ==
{{{
$ mkdir ppcdroid
$ cd ppcdroid
$ repo init -u git://gitorious.org/ppcdroid/manifest.git
$ repo sync
}}}

== Build kernel ==
To build kernel the Android compiler should be added into PATH variable:
{{{
$ cd ppcdroid
$ export PATH=$PWD/prebuilt/linux-x86/toolchain/powerpc-linux-4.3.1/bin
}}}

The kernel is located in root of android sources in kernel folder
{{{
$ cd ppcdroid
$ make ARCH=powerpc 44x/canyonlands_android_defconfig
$ make ARCH=powerpc CROSS_COMPILE=powerpc-android-linux- uImage 
$ cd arch/powerpc/boot/dts && dtc -I dts -O dtb -o canyonlands.dtb canyonlands.dts
}}}
uImage can be found in `arch/powerpc/boot` folder and device tree blob in `arch/powerpc/boot/dts` folder.

== Build rootfs ==

The next step is Android file system build. To build file system you need to specify for which board you want to build. Currently only Canyonlands platform is supported:
TARGET_PRODUCT=canyonlands.

To build rootfs:
{{{
$ cd ppcdroid
$ make TARGET_PRODUCT=canyonlands -j8
}}}

The number after '-j' is amount of available CPUs on your host system. This can significantly save time 
After build process finished you'll need rootfs for this do following:

{{{ 
$ cd out/target/product/canyonlands
$ mkdir android_rootfs
$ cp -r root/* android_rootfs
$ cp -r system android_rootfs
}}}

{{{
$ sudo ../../../../build/tools/mktarball.sh ../../../host/linux-x86/bin/fs_get_stats android_rootfs . rootfs rootfs.tar.bz2
}}}

== preparing HDD for booting ==
Linux kernel and the device tree blob file can be booted from the USB stick and the Android rootfs can be located on th HDD.
To prepare bootable USB stick and HDD with Android rootfs:
 # Create single VFAT partition on the USB stick and put uImage and device tree blob file on it
 # Create single ext3 partition on the IDE hard drive and unpack rootfs tarball on it
== preparing NFS for booting ==
TBD
== booting from HDD ==
To boot the kernel and the device tree blob file from the USB stick and the rootfs from the HDD:
 *# Start USB subsystem in the U-boot:
{{{
# usb start
}}}
 * Clarify USB stick device and partition numbers:
{{{
# usb storage
        Device 0: Vendor: USB 2.0  Rev: 0.00 Prod: USB Flash Drive
                  Type: Removable Hard Disk
                  Capacity: 3856.0 MB = 3.7 GB (7897088 x 512)
        Device 1: Vendor: Generic  Rev: 0.00 Prod: USB Flash Disk
                  Type: Removable Hard Disk
                  Capacity: 3856.0 MB = 3.7 GB (7897088 x 512)
}}}
 Say USB stick with the uImage and device tree blob is the Device 0:
{{{
# usb part 0
      print_part of 0

      Partition Map for USB device 0  --   Partition Type: DOS

      Partition     Start Sector     Num Sectors     Type
          1                   63         7886529       b 
}}}
 So the device number is '0' and the partition number is '1'.
 * Load uImage and device tree blob from the USB stick:
{{{
# fatload usb 0:1 0x300000 uImage
# fatload usb 0:1 0x3000000 canyonlands.dtb
}}}
 * Setup bootargs for the USB/IDE boot:
{{{
# setenv bootargs root=/dev/hde1 rw rootwait console=ttyS0,115200 init=/init
}}}
 * Boot the kernel
{{{
# bootm 300000 - 3000000
}}}
== booting from NFS ==
TBD